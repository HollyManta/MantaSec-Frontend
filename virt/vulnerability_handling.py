import security_functions

def r2br(output):
    output = output.replace("\n\n","<br>")
    return output

def skipVuln(name):
    skipMe =    [
                'Ethernet MAC Addresses',
                'Traceroute Information',
                'Device Type',
                'Service Detection',
                'VMware ESX/GSX Server detection',
                'Nessus Scan Information',
                'Local Checks Not Enabled (info)',
                'TCP/IP Timestamps Supported',
                'OS Identification',
                'Microsoft Windows SMB Service Detection',
                'OS Identification and Installed Software Enumeration over SSH v2 (Using New SSH Library)',
                'Authenticated Check : OS Name and Installed Package Enumeration',
                'Common Platform Enumeration (CPE)',
                'Microsoft Windows SMB2 Dialects Supported (remote check)',
                'Microsoft Windows SMB Versions Supported (remote check)',
                'Microsoft Windows NTLMSSP Authentication Request Remote Network Name Disclosure',
                'Windows NetBIOS / SMB Remote Host Information Disclosure',
                'DCE Services Enumeration',
                'SSL Root Certification Authority Certificate Information',
                'SSL Certificate Information',
                'SSL / TLS Versions Supported',
                'HyperText Transfer Protocol (HTTP) Information',
                'Nessus SYN scanner',
                'SSL Certificate Expiry - Future Expiry',
                'OpenSSL Detection',
                'Additional DNS Hostnames',
                'Apache HTTP Server Version',
                'Web Server No 404 Error Code Check',
                'SSL Cipher Suites Supported',
                'Web Server robots.txt Information Disclosure',
                'HTTP Server Type and Version',
                'DHCP Server Detection',
                'SSL Certificate Cannot Be Trusted',
                'Flash Player Detection',
                'Microsoft .NET Security Rollup Enumeration',
                'Microsoft .NET Framework Detection',
                'Microsoft Internet Explorer Version Detection',
                'Microsoft Windows Time Zone Information',
                'Ethernet Card Manufacturer Detection'
                ]

    if name in skipMe:
        return True
    else:
        return False

def addVuln(vulnlist, name, affected, description, risk):
    riskColors =    {
                    "Critical":"critical",
                    "High":"high",
                    "Medium":"medium",
                    "Low":"low",
                    "None":"info"
                    }

    vulnOrder = ["Critical", "High", "Medium", "Low", "None"]
    
    affected = str.join(", ", affected)

    # TODO - turn this into a template
    vulnlist += '<div class="row">'
    vulnlist += '<div class="widget-one">'
    vulnlist += '<div class="widget vuln-' + security_functions.cleanRisk(risk) + '-widget">'
    vulnlist += '<h3 class="">' + security_functions.entityEncode(name) + '</h3>'

    if isinstance(description, str):
        vulnlist += '<p class="vuln-desc">' + r2br(security_functions.entityEncode(description)) + '</p>'
    else:
        for rating in vulnOrder:
            for issue in description:
                if issue["risk"] == rating:
                    vulnlist += '<p class="vuln-desc padded-top-ten">'
                    vulnlist += '<span class="' + riskColors[issue["risk"]] + '-text">'
                    vulnlist += security_functions.entityEncode(issue["name"]) + '</span></p>'
                    vulnlist += '<p class="vuln-desc">' + r2br(security_functions.entityEncode(issue["description"])) + '</p>'
                    # TODO - why is this a list but when not aggregated it is not?
                    subAffected = str.join(", ", issue["affected"])
                    vulnlist += '<p class="vuln-hosts padded-top-five"><b>Affected hosts:</b> ' + security_functions.entityEncode(subAffected) + '</p>'

    vulnlist += '<p class="vuln-hosts padded-top-twenty"><b>Affected hosts:</b> ' + security_functions.entityEncode(affected) + '</p>'
    vulnlist += '</div>'
    vulnlist += '</div>'
    vulnlist += '</div>'
    return vulnlist

def orderVulns(vulns):
    # TODO update "Aggregated" to the highest rating before adding here
    vulnOrder = ["Aggregated", "Critical", "High", "Medium", "Low", "None"]
    vulnlist = ""

    for rating in vulnOrder:
        for vuln in vulns:
            if vuln["risk"] == rating:
                if not skipVuln(vuln["name"]):
                    vulnlist = addVuln(vulnlist, vuln["name"], vuln["affected"], vuln["description"], vuln["risk"])

    return vulnlist